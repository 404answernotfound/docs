---
title: Squashing migrations
metaTitle: How to squash multiple migration files into a single migration
metaDescription: How to squash multiple migration files into a single migration
---

<TopBlock>

This guide describes how to squash multiple [migration files](/concepts/components/prisma-migrate#migration-history) into a single migration.

</TopBlock>

## About squashing migrations

There are two common use cases for squashing multiple `migration.sql` files into a single migration:

- Migrate cleanly from a development environment
- Create a clean history in a production environment

### Migrate cleanly from a development environment

Squashing migrations can be useful when developing with a branch-based workflow. During a large local development effort on a feature branch you might generate multiple migrations using `migrate dev`. After the feature is finished, the migration history might contain unnecessary intermediate steps that are unwanted in the final migration history that will be pushed to the `main` branch.

There could be important reasons to avoid applying the intermediate steps in production â€” they might lose data or be extremely slow / disruptive). Even when this is not the case, you may want to avoid clutter in your production environment's migrations history.

For detailed steps on how to achieve this using `migrate diff`, see the section on [how to squash local migrations into a single file](#how-to-squash-local-migrations-into-a-single-file).

### Create a clean history in a production environment

The practice of using `migrate diff` is used to for minimize number of migration files in your production so that anyone pulling from production gets a clean package.

Consider the following scenario:
The productionenviroment has accumulated a longer migration history. Replaying it in new environments has become a burden due to intermediate steps requiring extra time. Since the team is not deriving value from the migration steps (and could get them back from git history in a pinch) the decision is made to squash the whole history into a single migration.

For detailed instructions, refer to --anchor link to steps below--.

## Important considerations

<Admonition type="info">

- When squashing migrations, be aware that any custom SQL in your **migration.sql** files will not be retained.

</Admonition>

## Using migration squashing

.... provide steps for both use cases here, with the code snippets and the Start and End states that Matthias provides in his Notion doc...

### How to squash local migrations into a single file

Before squashing migrations, make sure you have the following starting conditions:

- The contents of the migrations to be squashed are not yet applied on the production database
- All migrations applied to production are part of the local migration history already
- There is no custom SQL in the migration files

Then follow these steps:

1. Reset your local migration history folder to match the migration history on the `main` branch

2. Create an empty `migration.sql` file and make a note of the file path

3. Create a migration that takes you:

   - from the state of the `main` branch as described in your reset migration history
   - to the state of your local feature as described in your `schema.prisma` file
   - and outputs this to the `migration.sql` file created above

   You can do this using the `migrate diff` command:

   ```terminal
   npx prisma migrate diff \
   --preview-feature \
   --from-migrations ./migrations \
   --to-schema-datamodel ./schema.prisma \
   --script > filepath
   ```

You should now have a single migration file that can be applied to production using `migrate deploy`.

### Create a clean history in a production environment
